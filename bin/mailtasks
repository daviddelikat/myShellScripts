#!/usr/bin/env perl

use warnings;
use strict;

use Mail::IMAPClient;
use JSON;

my $host = 'imap.everyone.net';
my $id = 'david@plainblack.com';
my $pass = '2O*41DI9!1Ax';

        my $imap = Mail::IMAPClient->new(  
                        Server => $host,
                        User    => $id,
                        Password=> $pass,
                        Uid => 1,
        )       or die "Cannot connect to $host as $id: $@";

print ' total messages:'.$imap->message_count('INBOX')."\n";
$imap->select('INBOX') or warn 'failed to select';
my $json = JSON->new->pretty;
my $counter =0;
#$imap->subject($_) =~ /reports at my-atg/i and $imap->seen($_) && $counter++
#print $imap->subject($_)."\n"
#print $imap->get_header($_,'From')."\n"

$imap->get_header($_,'From') =~ /reports at my-atg/i and
		++ $counter && $imap->see($_) 
	for $imap->search( 'From '.$imap->Quote('My-ATG').' NOT SEEN' );

$imap->get_header($_,'From') =~ /(linode alert|reports at my-atg|logwatch)/i and
		++ $counter && $imap->see($_) 
	for $imap->search( 'NOT SEEN' );

$imap->get_header($_,'From') =~ /root.*plainblack.(net|com)/i and
		$imap->get_header($_,'Subject') =~ /Cron/ and
		++ $counter && $imap->see($_) 
	for $imap->search( 'NOT SEEN' );

print "$@\n" if $@;
print "messages changed: $counter\n";
#print join "\n", $imap->messages;
#print join "\n", map { $json->encode($_) } $imap->messages;

